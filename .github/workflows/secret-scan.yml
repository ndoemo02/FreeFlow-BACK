name: Secret Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Scan for secrets
      run: |
        echo "🔍 Scanning for potential secrets..."
        
        # Patterns to detect
        PATTERNS=(
          "sk-[a-zA-Z0-9]{48}"
          "AIza[0-9A-Za-z\\-_]{35}"
          "eyJ[a-zA-Z0-9_=]+\\.[a-zA-Z0-9_=]+\\.[a-zA-Z0-9_\\-\\+\\/=]*"
          "AKIA[0-9A-Z]{16}"
          "ya29\\.[0-9A-Za-z\\-_]+"
          "1//[0-9A-Za-z\\-_]+"
          "AIza[0-9A-Za-z\\-_]{35}"
          "AIza[0-9A-Za-z\\-_]{35}"
        )
        
        FOUND_SECRETS=false
        
        for pattern in "${PATTERNS[@]}"; do
          if git diff --name-only HEAD~1 HEAD | xargs grep -l "$pattern" 2>/dev/null; then
            echo "❌ Potential secret found matching pattern: $pattern"
            FOUND_SECRETS=true
          fi
        done
        
        if [ "$FOUND_SECRETS" = true ]; then
          echo "🚨 SECRET DETECTED! Please remove secrets from code."
          echo "💡 Use environment variables or GitHub Secrets instead."
          exit 1
        else
          echo "✅ No secrets detected in diff"
        fi
        
    - name: Comment on PR if secrets found
      if: failure() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '🚨 **Secret Detection Alert**\n\nPotential secrets detected in this PR. Please remove them and use environment variables or GitHub Secrets instead.\n\n**Action Required:**\n- Remove hardcoded API keys, tokens, or credentials\n- Use environment variables or GitHub Secrets\n- Update documentation if needed'
          })
